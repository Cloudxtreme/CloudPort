---
- hosts: cloudport
  vars:
  vars_files:
    - ../vars/application.yml
    - ../vars/secrets.yml
  sudo: yes
  sudo_user: "{{app_user_name}}"
  tasks:
    - name: Install bundler
      gem: name=bundler version={{bundler_version}}
    - name: Get P.T.U. code from Git
      git: repo={{ptu_repo}}
           dest={{ptu_path}}
           version={{ptu_version}}
           depth=1
           force=yes
      notify:
        - Install P.T.U. dependencies
    - name: Get application code from Git
      git: repo={{app_repo}}
           dest={{app_path}}
           version={{app_version}}
           force=yes
      notify:
        - Bundle install
        - Create database
        - Load database schema
        - Run database migrations
        - Ensure application PID directory
        - Reload application server
  handlers:
    - name: Install P.T.U. dependencies
      shell: ". {{app_user_bashrc}} && script/install"
      args:
        chdir: "{{ptu_path}}"
    - name: Bundle install
      shell: "{{bundle}} install --retry=5 --deployment --without '{{bundle_without}}'"
      args:
        chdir: "{{app_path}}"
    - name: Create database
      shell: "{{bundle}} exec rake db:create && touch {{db_created_flag}}"
      args:
        chdir: "{{app_path}}"
        creates: "{{db_created_flag}}"
    - name: Load database schema
      shell: "{{bundle}} exec rake db:schema:load && touch {{db_schema_loaded_flag}}"
      args:
        chdir: "{{app_path}}"
        creates: "{{db_schema_loaded_flag}}"
    - name: Run database migrations
      shell: "{{bundle}} exec rake db:migrate"
      args:
        chdir: "{{app_path}}"
    - name: Ensure application PID directory
      shell: "sudo {{app_pid_dir_script}}"
    - name: Reload application server
      shell: "sudo {{app_reload_script}}"
