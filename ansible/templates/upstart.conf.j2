# {{ ansible_managed }}
#
# Simple Rails application server instance
#
description	"Rails application server: {{ app_name }}"
author 		"Ivan Ilves <ivan.ilves@gmail.com>"

start on runlevel [2345]
stop on runlevel [!2345]

setuid {{ app_user_name }}
setgid {{ app_group_name }}
umask 022

chdir {{ app_path }}

pre-start script
  sudo {{ app_pid_dir_script }}
end script

pre-stop script
  [ -f {{ app_server_pid_file }} ] && kill -USR2 $(cat {{ app_server_pid_file }})
end script

script
  trap '' HUP # Do NOT use upstart provided punk-ass reload!

  export HOME={{ app_user_home }}

  . {{ app_conf_file }}

  bundle exec {{ app_server_name }} \
    --bind tcp://{{ app_server_bind }}:{{ app_server_port }} \
    --environment {{ app_env }} \
    --tag {{ app_name }} \
    --pidfile {{ app_server_pid_file }} \
    --redirect-stdout {{ app_server_out_file }} --redirect-stderr {{ app_server_err_file }}
end script
