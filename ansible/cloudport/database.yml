---
- hosts: cloudport
  vars_files:
    - ../variables.yml
    - ../secrets.yml
  sudo: yes
  tasks:
    - name: Install MySQL
      apt: pkg={{item}} state=latest
      with_items:
        - mariadb-server
        - mariadb-client
        - libmariadbclient-dev
      notify:
        - Start MySQL
    - name: Install Python interface to MySQL
      apt: pkg=python-mysqldb state=latest
    - name: Setup MySQL root user
      mysql_user: name=root
                  host={{item}}
                  password={{mysql_root_password}}
                  check_implicit_admin=yes
                  login_user=root
                  login_password={{mysql_root_password}}
                  state=present
      with_items:
        - localhost
        - "{{ansible_hostname}}"
        - 127.0.0.1
        - ::1
    - name: Setup MySQL application user
      mysql_user: name=cloudport
                  priv=*.*:ALL
                  host=localhost
                  password={{mysql_user_password}}
                  check_implicit_admin=yes
                  login_user=root
                  login_password={{mysql_root_password}}
                  state=present
    - name: Create application user my.cnf
      template: src=templates/my.cnf.j2 dest="{{app_user_home}}/.my.cnf" owner=cloudport group=cloudport mode=0600
  handlers:
    - name: Start MySQL
      service: name=mysql state=started

